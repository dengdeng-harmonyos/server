name: Build and Release

on:
  push:
    branches:
      - main # 测试环境
      - release # 生产环境
  workflow_dispatch:

jobs:
  build:
    name: Build Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get dependencies
        run: go mod download

      - name: Build with embedded secrets
        env:
          AGCONNECT_JSON: ${{ secrets.AGCONNECT_JSON }}
          PRIVATE_JSON: ${{ secrets.PRIVATE_JSON }}
          ENCRYPTION_KEY: ${{ secrets.PUSH_TOKEN_ENCRYPTION_KEY }}
        run: |
          # Base64编码JSON字符串用于ldflags（避免转义问题）
          AGCONNECT_BASE64=$(echo "$AGCONNECT_JSON" | base64 -w 0)
          PRIVATE_BASE64=$(echo "$PRIVATE_JSON" | base64 -w 0)
          ENCRYPTION_KEY_BASE64=$(echo "$ENCRYPTION_KEY" | base64 -w 0)

          # 使用ldflags注入secrets到二进制文件（静态链接）
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "\
            -X 'github.com/dengdeng-harmonyos/server/internal/config.embeddedAgConnectJSON=$AGCONNECT_BASE64' \
            -X 'github.com/dengdeng-harmonyos/server/internal/config.embeddedPrivateJSON=$PRIVATE_BASE64' \
            -X 'github.com/dengdeng-harmonyos/server/internal/config.embeddedEncryptionKey=$ENCRYPTION_KEY_BASE64' \
            -s -w" \
            -o bin/dengdeng-server \
            cmd/server/main.go

          chmod +x bin/dengdeng-server
          echo "Binary info:"
          file bin/dengdeng-server
          ls -lh bin/dengdeng-server

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dengdeng-server-${{ github.sha }}
          path: bin/dengdeng-server
          retention-days: 30

  # 测试环境部署 (main 分支)
  deploy-test:
    name: Deploy to Test Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dengdeng-server-${{ github.sha }}
          path: bin

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          chmod +x bin/dengdeng-server
          docker build -f Dockerfile -t dengdeng-server:test-${{ github.sha }} .
          docker save dengdeng-server:test-${{ github.sha }} -o dengdeng-server-test.tar
          chmod 644 dengdeng-server-test.tar
          ls -lh dengdeng-server-test.tar

      - name: Deploy to Test Server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SERVER_SSH_KEY }}
          port: ${{ secrets.TEST_SERVER_PORT }}
          source: 'dengdeng-server-test.tar'
          target: '/tmp/'

      - name: Execute deployment commands on Test Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TEST_SERVER_HOST }}
          username: ${{ secrets.TEST_SERVER_USER }}
          key: ${{ secrets.TEST_SERVER_SSH_KEY }}
          port: ${{ secrets.TEST_SERVER_PORT }}
          script: |
            # 加载 Docker 镜像
            docker load -i /tmp/dengdeng-server-test.tar
            docker tag dengdeng-server:test-${{ github.sha }} dengdeng-server:test-latest

            sh /opt/dengdeng-deploy-test.sh

            echo "测试环境部署完成"

  # 生产环境部署 (release 分支)
  deploy-production:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: dengdeng-server-${{ github.sha }}
          path: bin

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker Image
        run: |
          chmod +x bin/dengdeng-server
          docker build -f Dockerfile -t dengdeng-server:prod-${{ github.sha }} .
          docker tag dengdeng-server:prod-${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/dengdeng-server:latest
          docker tag dengdeng-server:prod-${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/dengdeng-server:$(date +%Y%m%d)
          docker save dengdeng-server:prod-${{ github.sha }} -o dengdeng-server-prod.tar
          chmod 644 dengdeng-server-prod.tar
          ls -lh dengdeng-server-prod.tar

      - name: Deploy to Production Server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_PORT }}
          source: 'dengdeng-server-prod.tar'
          target: '/tmp/'

      - name: Execute deployment commands on Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_PORT }}
          script: |
            # 加载 Docker 镜像
            docker load -i /tmp/dengdeng-server-prod.tar
            docker tag dengdeng-server:prod-${{ github.sha }} dengdeng-server:latest

            # 停止并删除旧容器
            docker rm -f push-server || true

            # 运行新容器
            cd /opt/dengdeng && ./deploy.sh

            # 清理临时文件
            rm -f /tmp/dengdeng-server-prod.tar

            # 清理旧镜像
            docker image prune -f

            echo "生产环境部署完成"

      - name: Push to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/dengdeng-server:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/dengdeng-server:$(date +%Y%m%d)
          echo "镜像已推送到 Docker Hub"
